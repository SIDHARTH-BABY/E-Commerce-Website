<section>
  <div class="container">



    <div class="mt-5">
      <div class="cupon_area">
        <div class="check_title">
          <h2>Apply Coupon get ₹60 off</h2>
        </div>
        {{#each viewCoupon}}
        <div>
          <input type="text" value="{{this.coupon}}" id="myInput" style="color: red; font-weight: bold">
          <button onclick="myFunction()" class="btn btn-primary ">Copy</button>
        </div>
        {{/each}}


        <div>
          <input type="text" placeholder="Enter coupon code" id="couponCode">
          <button onclick="applyCoupon()" class="btn btn-success ml-1 mt-2" type="submit"> Apply </button>
        </div>

      </div>

    </div>





    <form id="checkout-form">


      {{!-- {{#each selectAddress}} --}}
      <div class="container my-5 py-5">

        <!--Section: Design Block-->
        <section>

          <div class="row">



            <div class="col-md-8 mb-4">
              <div class="card mb-4">
                <div class="card-header py-3">
                  <h5 class="mb-0 text-font text-uppercase">Delivery address</h5>
                </div>
                <div class="card-body">




                  <div class="form-outline mb-4  ">
                    <div class="form-outline flex-fill ">
                      <label class="form-label" for="form3Example3c">Name</label>
                      <input type="text" id="form3Example3c" value="{{selectAddress.name}}" name="name"
                        class="form-control" required />
                    </div>
                  </div>

                  <div class="form-outline mb-4">
                    <div class="form-outline flex-fill ">
                      <label class="form-label" for="form3Example3c">Email</label>
                      <input type="text" id="form3Example3c" value="{{selectAddress.Email}}" name="email"
                        class="form-control" required />
                    </div>
                  </div>

                  <div class="form-outline mb-4">
                    <div class="form-outline flex-fill ">
                      <label class="form-label" for="form3Example3c">Mobile</label>
                      <input type="text" id="form3Example3c" value="{{selectAddress.mobile}}" name="mobile"
                        class="form-control" required />
                    </div>
                  </div>

                  <div class="form-outline mb-4">
                    <div class="form-outline flex-fill mb-0">
                      <label class="form-label" for="form3Example1c">Building Name</label>
                      <input type="text" id="address" value="{{selectAddress.building}}" name="address"
                        class="form-control" required />
                    </div>
                  </div>

                  <div class="form-outline mb-4">
                    <div class="form-outline flex-fill mb-0">
                      <label class="form-label" for="form3Example1c">Street</label>
                      <input type="text" id="address" value="{{selectAddress.street}}" name="address"
                        class="form-control" required />
                    </div>
                  </div>


                  <div class="form-outline mb-4">
                    <div class="form-outline flex-fill mb-0">
                      <label class="form-label" for="form3Example1c">City</label>
                      <input type="text" id="address" value="{{selectAddress.city}}" name="address" class="form-control"
                        required />
                    </div>
                  </div>


                  <div class="form-outline mb-4">
                    <div class="form-outline flex-fill mb-0">
                      <label class="form-label" for="form3Example3c">District</label>
                      <input type="text" id="form3Example3c" name="distirct" value="{{selectAddress.district}}"
                        class="form-control" required />
                    </div>
                  </div>

                  <div class="form-outline mb-4">
                    <div class="form-outline flex-fill mb-0">
                      <label class="form-label" for="form3Example3c">State</label>
                      <input type="text" id="form3Example3c" name="state" value="{{selectAddress.state}}"
                        class="form-control" required />
                    </div>
                  </div>
                  <div class="form-outline mb-4">
                    <div class="form-outline flex-fill mb-0">
                      <label class="form-label" for="form3Example4c">Pincode</label>
                      <input type="text" id="pincode" name="pincode" value="{{selectAddress.pincode}}"
                        class="form-control" required />
                      <input type="text" name="userId" id="userId" value="{{user._id}}" hidden>

                      <div>
                        <input type="text" name="Couponname" id="" value="" hidden>
                      </div>
                      <div>
                        <input type="text" name="Discount" id="Discount" value="" hidden>
                      </div>
                      <div>
                        <input type="text" name="grandtotal" id="grandtotal" value="" hidden>
                      </div>
                      <div>
                        <input type="text" name="" id="" value="{{total}}" hidden>
                                  
                      </div>

                    </div>
                  </div>







                </div>

              </div>


            </div>
            <div class="col-md-4 mb-4 position-static">
              <div class="card-header py-3">
                <h5 class="mb-3 text-font ml-3"> Select Address<span class="float-end mt-1"
                    style="font-size: 13px ;"></span></h5>
                <div class="card mb-4">
                  {{#each userAddress}}

                  <p>
                    <a class="btn btn-primary ml-3 mt-3" data-toggle="collapse" href="#collapseExample" role="button"
                      aria-expanded="false" aria-controls="collapseExample">
                      Address{{inc @index}}
                    </a>

                  </p>
                  <div class="collapse" id="collapseExample">
                    <div class="card card-body">

                      <p class="card-text">Name: {{this.name}}</p>
                      <p class="card-text">mobile: {{this.mobile}}</p>
                      <p class="card-text">Email: {{this.Email}}</p>
                      <p class="card-text">City: {{this.city}}</p>
                      <p class="card-text">District: {{this.district}}</p>
                      <p class="card-text">State: {{this.state}}</p>
                      <p class="card-text">Country: {{this.country}}</p>

                      <a href="/place-order?id={{this.id}}" class="btn btn-success btn-block ">Select Address</a>
                    </div>
                  </div>

                  {{/each}}





                  <div class="card-header py-3">
                    <h5 class="mb-0 text-font">Purchase Reciept<span class="float-end mt-1"
                        style="font-size: 13px ;"></span></h5>
                  </div>
                  <div class="card-body">


                    <div class="card-footer mt-4">
                      <div class="card-body  ">


                        <div class="custom-control custom-radio">
                          <input type="radio" class="note note-dark text-secondary" value="COD" name="payment-method">
                          <label class="note note-dark text-secondary text-dark" for="defaultUnchecked">Cash on
                            Delivery</label>
                        </div>

                        <div class="custom-control custom-radio">
                          <input type="radio" class="note note-dark text-secondary" value="ONLINE"
                            name="payment-method">
                          <label class="note note-dark text-secondary text-dark" for="defaultUnchecked">Online
                            Payment</label>
                        </div>





                      </div>

                      <ul class="list-group list-group-flush">
                        <li
                          class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0 text-muted">
                          Subtotal
                          <span id="total">{{total}}</span>
                        </li>
                        <li
                          class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0 text-muted">
                          Discount
                          <span id="discount">0</span>
                        </li>
                        <li
                          class="list-group-item d-flex justify-content-between align-items-center px-0 fw-bold text-uppercase">

                          Total Amount Rs:
                          <span id="Grandtotal">0</span>
                            
                        </li>
                      </ul>

                      <Button type="submit" class="btn btn-warning mt-3">Place Order</Button></Button>
                    </div>


                  </div>

                </div>
              </div>





            </div>

        </section>
        <!--Section: Design Block-->

      </div>








    </form>




  </div>







</section>


<script>


  function applyCoupon() {

   

    var coupon = document.getElementById('couponCode').value

  

    var userId = document.getElementById('userId').value




    var total = document.getElementById('total').innerHTML





    $.ajax({
      url: '/apply-coupon',
      method: 'post',
      data: {
        coupon: coupon,
        userId: userId

      },
      success: (response) => {
        console.log(response, "responseresponse")
        if (response.expirry) {
          alert('your coupon has expired')
        } else if (response.used) {
          alert('coupon is already used')
        } else if (response.unAvailable) {
          alert('sorry! its not valid')
        } else {
          var discount = response.price
          console.log(discount)
          var Grandtotal = total - discount
          console.log(Grandtotal)
          document.getElementById('discount').innerHTML = discount

          document.getElementById('Grandtotal').innerHTML = Grandtotal
          document.getElementById('Couponname').innerHTML = response.Couponname
          document.getElementById('Couponname').value = response.Couponname
          document.getElementById('Grandtotal').value = Grandtotal
          document.getElementById('grandtotal').value = Grandtotal
          document.getElementById('discount').value = discount
          document.getElementById('Discount').value = discount

          swal({
            title: "Congrats",
            text: "Succesfully Added Coupon",
            icon: "success",
            button: "ok",
          });
        }
      }
    })
  }




</script>


<script>

  document.getElementById('checkout-form').addEventListener('submit', function (evt) {
    evt.preventDefault();
    $.ajax({
      url: '/place-order',

      method: 'post',
      data: $('#checkout-form').serialize(),
      success: (response) => {

        if (response.codSuccess) {
          location.href = '/order-success'
        } else {
          razorpayPayment(response)

        }

      }
    })

  })

  function razorpayPayment(order) {

    var options = {
      "key": "rzp_test_OsmjfmpnYOiWtv", // Enter the Key ID generated from the Dashboard
      "amount": (order.amount) * 100, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
      "currency": "INR",
      "name": "Food Court",
      "description": "Test Transaction",
      "image": "https://www.canva.com/design/DAFK3SX6FTo/_FBZbqtkI2Ha7kR8XGGcDQ/edit?utm_content=DAFK3SX6FTo&utm_campaign=designshare&utm_medium=link2&utm_source=sharebutton",
      "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
      "handler": function (response) {

        verifyPayment(response, order)
      },
      "prefill": {
        "name": "Gaurav Kumar",
        "email": "gaurav.kumar@example.com",
        "contact": "9999999999"
      },
      "notes": {
        "address": "Razorpay Corporate Office"
      },
      "theme": {
        "color": "#3399cc"
      }
    };

    var rzp1 = new Razorpay(options);
    rzp1.open();
  }

  function verifyPayment(payment, order) {
    $.ajax({
      url: '/verify-payment',
      data: {
        payment,
        order
      },
      method: 'post',
      success: (response) => {
        if (response.status) {
          location.href = '/order-success'

        } else {
          alert('payment failed')
        }

      }
    })
  }



</script>





<style>
  .text-font {
    font-family: futura-pt, Tahoma, Geneva, Verdana, Arial, sans-serif;
    font-weight: 700;
    letter-spacing: .156rem;
    font-size: 1.125rem;
  }

  .text-price {
    padding: 0 .625rem;
    font-family: futura-pt, Tahoma, Geneva, Verdana, Arial, sans-serif;
    font-style: normal;
    font-size: .75rem;
    font-weight: 700;
    line-height: .813rem;
    letter-spacing: 1.6px;
  }

  .text-descriptions {
    font-family: futura-pt, Tahoma, Geneva, Verdana, Arial, sans-serif;
    font-style: normal;
    font-size: .75rem;
    font-weight: 400;
    line-height: 1.125rem;
    margin: .313rem 0 .938rem;
    padding: 0 .625rem;
  }

  .button-color {
    color: #4e4e4e;
    border-color: #4e4e4e;
  }

  .button-order {
    font-family: futura-pt, Tahoma, Geneva, Verdana, Arial, sans-serif;
    font-style: normal;
    font-size: .75rem;
    font-weight: 700;
    background-color: hsl(90, 40%, 50%);
    color: rgb(122, 117, 117);
  }
</style>

<script>
  function myFunction() {
    // Get the text field
    var copyText = document.getElementById("myInput");

    // Select the text field
    copyText.select();
    copyText.setSelectionRange(0, 99999); // For mobile devices

    // Copy the text inside the text field
    navigator.clipboard.writeText(copyText.value);

    // Alert the copied text
    swal("coupon Successfully Copied");
  }
</script>